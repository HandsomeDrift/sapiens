# SAGE-Pose：结构先验引导的双教师半监督微调

## 1) 架构要点（创新点）

- **双教师（EMA）+ 单学生**：
  - **Geom-Teacher（几何教师）**：只做**几何类弱增强**（仿射/尺度/轻旋转），强调**骨架拓扑一致性**与关节几何稳定性。
  - **App-Teacher（外观教师）**：只做**外观类弱增强**（颜色、模糊、噪声），强调**外观不变性**与可见性判断。
     两个教师都由学生的参数 **EMA** 更新，但**分头看不同扰动**，最后**对无标签样本生成两套伪热图/坐标与置信度**，做**加权集成**（下文详述）。
- **多路径强增强一致性（单学生，多强视图）**：学生对同一无标签样本同时接收 **2–3 路不同的强增强**，要求各路预测对齐**同一个**教师目标（或两教师集成目标），能显著提升强扰动下的稳健性。
- **骨架图正则（结构先验）**：在无标签上加入**图拉普拉斯/边对齐**等**拓扑损失**（关节之间的长度比与角度合理性），作为**低权重软约束**，在标注稀缺时抑制奇异姿态。
- **关键点自适应遮挡（AKM）+ 关键点感知 CutMix**：对**难点关节**自适应遮挡/替换，通过教师软热图指导学生恢复，逼迫模型学习**隐蔽/遮挡姿态**与**肢体连贯**。
- **双层过滤（实例→关键点）+ 动态阈值**：先按**OKS/实例置信**择优样本，再按**关键点置信**逐点掩码；关键点阈值按**类别运行统计**自适应（Free/FlexMatch 思路），减少长尾关键点的“被放弃”。

> 直觉：把“**几何**稳定性（Geom-Teacher）”与“**外观**稳定性（App-Teacher）”解耦，各自更会“挑错”，再融合；学生在**多路强增**下追一个“综合可信”的目标，同时用**骨架先验**兜底，训练更稳。

------

## 2) 训练流程（分阶段）

**Stage 0：监督热身（仅 L）**

- 用你现成的通用 2D 模型（ViTPose/RTMPose/HRNet/Sapiens-style 皆可）在小标注集 $L$ 上**只训监督头**，5–20 epoch，学到一个稳定起点。

**Stage 1：伪标签自举（L + U，双教师上线）**

- 两位教师各自对无标签 $U$ 的**弱增强视图**预测热图 $\tilde{H}^{g}, \tilde{H}^{a}$，并输出**每关节置信** $c_k^{g}, c_k^{a}$。
- **实例层**：对每个人体实例计算 OKS/综合置信，低于 $\tau_{\text{ins}}$ 的整人**丢弃**。
- **关键点层**：对保留的实例，按**自适应阈值** $\tau_k$（随训练更新）逐点筛选；得到掩码 $m_k\in\{0,1\}$。
- **教师融合**：对被保留关键点，做**置信度加权平均**得到目标热图 $\bar{H}_k = \alpha_k \tilde{H}^{g}_k + (1-\alpha_k)\tilde{H}^{a}_k$，其中 $\alpha_k \propto c_k^{g}$（温度缩放后归一）。

**Stage 2：多强视图一致性（学生）**

- 同一张无标签图像送入学生的**2–3 路强增强** $T_1,T_2,T_3$，得到 $H^{(1)},H^{(2)},H^{(3)}$。
- 对教师目标热图 $\bar{H}$ 施加相同几何变换 $T_i$（或对坐标做解析映射），最小化
   $\sum_i \| H^{(i)} - T_i(\bar{H}) \|_2^2$，仅在掩码 $m_k=1$ 的关节上计损。

**Stage 3：结构先验 & 轻量域适配**

- 加入**骨架图正则**与**长度/角度软约束**。
- 若存在明显域差（如俯视/鱼眼/特定人群），在 $L$ 上套用**风格迁移或频域替换（FDA/AdaIN-style）\**作为额外增强；在 $U$ 上加入\**相机几何/畸变仿真**强增一并训练。

------

## 3) 损失函数（示例）

$\mathcal{L} = \underbrace{\mathcal{L}_{\text{sup}}(L)}_{\text{监督热图MSE/CE + 可见性}} + \lambda_u \underbrace{\mathcal{L}_{\text{cons}}(U)}_{\text{多强视图一致性}} + \lambda_{\text{topo}} \underbrace{\mathcal{L}_{\text{topo}}(U)}_{\text{骨架拓扑}} + \lambda_{\text{bone}} \underbrace{\mathcal{L}_{\text{bone}}(U)}_{\text{骨长比例}} + \lambda_{\text{angle}} \underbrace{\mathcal{L}_{\text{angle}}(U)}_{\text{关节角合理}}$

- **监督项**：标准热图 MSE（或 KL/CE），可加可见/遮挡二分类 CE。
- **一致性**：
   $\mathcal{L}_{\text{cons}}=\sum_{i}\sum_{k} m_k \| H^{(i)}_k - T_i(\bar{H}_k)\|_2^2$。
- **骨架拓扑**（图拉普拉斯）：
   对骨架图 $G=(V,E)$，令关键点坐标为 $\mathbf{p}\in\mathbb{R}^{2|V|}$，
   $\mathcal{L}_{\text{topo}} = \|\mathbf{p}^\top L_G \mathbf{p}\|_1$，抑制不连续与折断。
- **骨长比例**：
   对每条骨 $e=(u,v)$，
   $\mathcal{L}_{\text{bone}}=\sum_e \big|\frac{\|\mathbf{p}_u-\mathbf{p}_v\|_2}{\overline{\ell}_e}-1\big|$，
   $\overline{\ell}_e$ 为在 $L$ 上统计的**稳健中值骨长**（按人尺度归一）。
- **关节角**：对关键三元组（如肩-肘-腕），用**hinge**或**von Mises**损失限制极端角度（权重很小，避免过拟合）。

------

## 4) 增强策略（要点）

- **弱增（给教师）**：Resize+轻旋转(±15°)+水平翻转；轻色偏/亮度抖动之一。
- **强增（给学生，多路径）**：RandAugment（去除强几何破坏）、Cutout(随机/肢段对齐)、**AKM 自适应遮挡**（优先遮难点关节邻域）、**关键点感知 CutMix**（骨架连贯的拼接），再叠加**畸变/仿射/薄板样条**（若目标域有视角变化）。
- **几何同步**：对所有几何变换**同步变换热图/坐标**；教师目标也同步 $T_i$。

------

## 5) 伪标签筛选与校准

- **实例先筛**：OKS 或平均关键点置信 $\ge \tau_{\text{ins}}$（如 0.70）。
- **关键点再筛**：每个关键点维护**置信运行均值/方差**，动态阈值
   $\tau_k(t)=\mu_k(t)-\beta \sigma_k(t)$（$\beta$ 取 0.5–1.0），少见/难点关节阈值更宽松。
- **分布对齐**：保持无标签中“可见/遮挡”比例与标注集接近（简单温度缩放或门限回调）。
- **教师融合温度**：对两教师置信做温度缩放 $c'=\text{softmax}(c/T)$，$T\in[0.5,1.5]$。

------

## 6) 跨域/跨数据集适配（可选）

- **风格/频域对齐**：在 L 上做 FDA/AdaIN，把外观向目标域靠拢；在 U 上保留原域，保证**外观多样性**。
- **相机模型增广**：鱼眼/广角/顶视用**径向畸变**与**仿射倾斜**模拟；同时调整骨长先验的尺度归一方式。
- **两阶段（检测→姿态）**（若是 top-down）：先对 U 产生**高质量人框伪标签**（可用教师融合 NMS），再做关键点半监督，减少漏检带来的负迁移。

------

## 7) 推荐超参（起步值）

- 批次构成：**L:U = 1:4**（如 16:64）；
- $\lambda_u$（无监督权重）：**0 → 1.0** 线性 ramp-up（前 5–10 epoch）；
- EMA 衰减：**0.996–0.999**；
- $\tau_{\text{ins}}=0.70$，关键点初始阈值 $\tau_k=0.90$ → 动态；
- 多强视图数 $M=2$ 或 3（3 更强但算力更高）；
- 拓扑/骨长/角度权重：$\lambda_{\text{topo}}=0.05,\ \lambda_{\text{bone}}=0.05,\ \lambda_{\text{angle}}=0.02$（总损失归一到监督量级的 5–10%）。

------

## 8) 落地细节 & 防坑清单

- **严格防泄漏**：U 中不能包含验证/测试；视频数据注意帧间泄漏。
- **置信与可见性**：教师同时输出**可见/遮挡**概率（或从热图峰值+面积估计），低可见关键点要么降权要么只用拓扑项。
- **离群沉默**：出现**大尺度错骨架/反人**的样本，实例层直接丢弃。
- **刷新策略**：伪标签**在线**（每步）或**周期性重估**（每 1–2 epoch）；后者更稳。
- **日志与校准**：每关节的选用率、平均置信、误差热力图都要打点；必要时对**少见关节**单独调阈值。
- **资源**：多强视图会涨显存；可用**半精度**、梯度累积、较小输入边长（训练期）缓解。

------

## 9) 建议的消融/对比（最能说明问题的几项）

1. 单教师 vs 双教师；
2. 多强视图 $M=1/2/3$；
3. 有/无 AKM 与关键点感知 CutMix；
4. 有/无骨架图正则（以及它与伪标签阈值的交互）；
5. 动态阈值 vs 固定阈值；
6. 域增广（FDA/相机畸变）的贡献；
7. 实例先筛 + 关键点再筛 vs 只做关键点筛。





太好了，我把 SAGE-Pose（你要做的半监督微调方案）的**“和别人不一样的点”**拆成几个维度讲清楚：谁在做什么、我们怎么改、为什么有效。每一点都给出“差异 → 机制 → 预期收益”。

# 1) 双教师解耦：几何教师 vs 外观教师

**现有做法**

- 多为**单教师 Mean-Teacher**（或对称双学生），在同一套弱/强增强下产出伪标签；教师只是一份“更平滑的学生”。
- 双分支/双学生方法常是**对称**的：两路学生训练目标一致、职责不区分。

**我们怎么做**

- **功能解耦**：两位教师“各司其职”：
  - **Geom-Teacher** 仅暴露在**几何类弱增强**（仿射、尺度、轻旋转）下，追求**骨架拓扑与几何稳定性**。
  - **App-Teacher** 仅暴露在**外观类弱增强**（颜色、模糊、噪声）下，追求**外观不变性和可见性判断**。
- **逐关键点加权融合**：按两位教师的**逐关键点置信**做温度缩放和加权，得到融合目标热图/坐标（弱增视图上）。

**为什么有效**

- 错误来源“可分离”：几何错（姿态扭曲）和外观错（遮挡、模糊、曝光）常不同步发生。解耦后，两位教师能**互为校验**，减少同源偏差的放大。
- 逐关键点融合比整实例打分更**细粒度**，可在同一人上保留“某些关节可靠、某些不可靠”的信息，提升伪标签**有效覆盖面**。

------

# 2) 单学生的「多强视图一致性」：多路径、低算力

**现有做法**

- FixMatch/UDA 系列：**弱→强**单对一致性；或**双学生/师生两网**叠加算力。
- 也有“单模型一致性”，但通常只做**一条强增强路径**。

**我们怎么做**

- **一个学生**，对同一无标签样本同时走 **2–3 条不同“强增强”路径**（几何/外观组合不同），各路预测都去对齐**同一个融合教师目标**（目标同步几何变换）。

**为什么有效**

- 多路径把“强增扰动空间”**显式覆盖**，能学到更强的**扰动不变性**；同时不必增加第二个学生/教师的显存与通讯开销。
- 教师是**稳定锚点**，多路径的一致性不至于塌缩到“互抄作业”。

------

# 3) 结构先验不是“装饰”：图拉普拉斯 + 骨长比例 + 角度

**现有做法**

- 骨长/对称等先验常作为**弱正则**零散出现，且很少与伪标签质量控制**联动**。

**我们怎么做**

- **三件套**：
  - **图拉普拉斯拓扑**：以骨架图为约束，惩罚“折断/不连续”的几何配置；
  - **骨长比例**：对每条骨与**标注集统计中值**比对，做尺度归一后的偏差约束；
  - **关节角**：对关键三元组施加轻量角度稳定项（hinge / von Mises）。
- **与伪标签联动**：当某实例/关键点的结构先验损失异常高时，**自适应下调**其一致性损失权重，避免把“坏伪标签”硬吃下去。

**为什么有效**

- 在标注稀缺下，结构先验能充当“**软约束防撞栏**”，和伪标签筛选形成闭环，**抑制确认偏差**导致的姿态漂移。

------

# 4) 针对“难点关节”的自适应增强：AKM + 关键点感知 CutMix

**现有做法**

- 随机 Cutout / CutMix 多用于分类/检测；在 HPE 里通常是**位置无关**的，甚至破坏骨架连贯。
- 少量工作会做“遮挡增强”，但规则固定、**不看样本难度**。

**我们怎么做**

- **AKM（Adaptive Keypoint Masking）**：根据教师**逐关键点不确定性**与历史错位率，**优先遮挡“学不会的关节”邻域**，让学生在强增路径下学会**补全/推理**。
- **关键点感知 CutMix**：CutMix 的拼接区域**沿骨架边/肢段**定位，保持骨架连贯，避免产生“非人类拓扑”的伪样本。

**为什么有效**

- 训练量被“难点”主导时，**有针对性地制造难例**比平均随机更高效；骨架感知的拼接能**扩大分布**同时不破坏物理可行性。

------

# 5) “实例→关键点”的双层筛选 + 动态阈值（Pose 版 FlexMatch）

**现有做法**

- 常见是**固定阈值**（例如 max-prob > 0.9）在热图/坐标层做掩码；或只在实例层筛一次。

**我们怎么做**

- **先实例、再关键点**：
  1. 以 OKS/实例均置信清掉“明显不靠谱”的整人；
  2. 对保留下来的实例，**逐关键点**用**运行均值-方差**自适应门限（难点关节阈值更宽松）。
- **分布校准**：保持无标签中的“可见/遮挡”比例与标注集接近（温度缩放或门限回调）。

**为什么有效**

- **两道闸**减少错误传播：大错先挡、细错后筛；动态阈值提高**长尾关节**的利用率，不让它们因“永远达不到0.9”而被系统性忽略。

------

# 6) 伪标签的「逐关键点」双教师融合（而非整图平均）

**现有做法**

- 融合时多是**整图/整实例层面**平均或投票。

**我们怎么做**

- **逐关键点**做温标置信加权（Geom-Teacher 倾向几何稳定的关节，如躯干；App-Teacher 在高噪/遮挡的**末端关节**时更可靠），得到更细粒度的目标。

**为什么有效**

- 姿态的不确定性**高度局部化**：把融合粒度下沉到关键点层，可显著降低“局部错误带坏整人”的风险。

------

# 7) 面向域差的相机物理增广与两阶段可选流程

**现有做法**

- 一般的颜色/裁剪增广难以覆盖鱼眼、顶视等强几何域差；
- Multistage（先检测再姿态）在半监督中很少显式利用**无标签的人框伪标签**质量控制。

**我们怎么做**

- **相机模型增广**：在强增路径里加入**径向畸变、透视倾斜**等相机物理模拟，把目标域几何差异**注入训练**；
- **两阶段可选**：top-down 流水线可**先用双教师产生高质量人框伪标签**（实例层 OKS+NMS 约束），再做关键点半监督，降低漏检噪声。

**为什么有效**

- 直接对**几何分布**做“因果扰动”，比纯外观增强更契合“新相机/新视角人群”的域迁移；分阶段把错误隔离到前端，**减少负迁移**。

------

## 和代表性方法的**对照总结**

- **vs 单教师 FixMatch/Mean-Teacher**：我们把教师**按扰动域专业化**，并做**逐关键点融合**，而不是一份通用教师 + 整图伪标签；再配合**多强视图一致性**，正则更强、算力更省。
- **vs 对称双学生去噪伪热图**：别人是“两路对等互教”，我们是**两位“不同专长”的教师** + **一个学生**，职责拆分、误差可解释；融合在**关键点层**而非整图层。
- **vs 仅用随机 Cutout/CutMix 的增强流派**：我们的增强**由难点统计与骨架拓扑“驱动”**，避免制造不可行拓扑；更聚焦“真正学不会”的区域。
- **vs 静态阈值/单层筛**：我们用**实例→关键点双层门控** + **动态门槛**（Pose-aware FlexMatch），对长尾关节更友好。
- **vs 仅有骨长或对称的弱先验**：我们把**拓扑/骨长/角度**作为一个整体，并和伪标签权重**联动**，在“结构异常”时自动**降权**，防止漂移。
- **vs 纯一致性单模型**：我们保留教师作为**稳定锚**，让多强视图有“参考”，避免一致性在强增空间里相互**共识性崩塌**。

------

## 怎么证明这些“真的有效”

建议重点做以下**消融与可视化**（能打动审稿人的那种）：

1. 单教师 vs 双教师（同算力）→ 看 mAP/OKS 与**伪标签净使用率**；
2. 逐关键点融合 vs 整实例融合 → 看**难点关节**（如踝、腕）提升；
3. 多强视图 $M=1/2/3$ → 看在强扰动下的一致性稳定性曲线；
4. AKM/骨架感知 CutMix 的贡献 → 可视化恢复遮挡肢段的热图质量；
5. 动态阈值 vs 固定阈值 → 看长尾关节**被选中比例**与准确率；
6. 结构先验与损失联动开/关 → 看**漂移样本**（拓扑异常）占比变化；
7. 相机物理增广开/关（有域差的目标集）→ 看跨视角泛化。

> 如果你告诉我当前的代码栈（如 mmpose/rtmpose/Sapiens-Pose）和数据格式（COCO-keypoints/自定义 JSON），我可以把以上机制落成**可直接插拔的模块与训练配置**，包括：双教师 EMA 更新与逐关键点融合、多强视图数据管道、AKM/CutMix 实现、拓扑正则与动态阈值的 hooks。